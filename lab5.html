<!DOCTYPE html>
<html>

<head>
  <title>D3.js Playground</title>
</head>

<body>
  <div>
    X:
    <select id="x-variable">
      <option value="Pregnancies" selected>Pregnancies</option>
      <option value="Glucose">Glucose</option>
      <option value="BloodPressure">BloodPressure</option>
      <option value="SkinThickness">SkinThickness</option>
      <option value="SkinThickness">SkinThickness</option>
    </select>
  </div>
  <div>
    Y:
    <select id="y-variable">
      <option value="Pregnancies">Petal Length</option>
      <option value="Glucose" selected>Petal Width</option>
      <option value="sepal.length">Sepal Length</option>
      <option value="SkinThickness">Sepal Width</option>
    </select>
  </div>
  <div>
    <button id="reset">Reset zoom</button>
  </div>
  <svg id="svg"></svg>

  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script type="csv" id="unparsed"></script>
  <form class="form-inline">
    <div class="form-group">
      <label for="files">Upload a CSV formatted file:</label>
      <input type="file" id="files"  class="form-control" accept=".csv" required />
    </div>
    <div class="form-group">
     <button type="submit" id="submit-file" class="btn btn-primary">Upload File</button>
     </div>
  </form>

  <script>
    let svg;
    let marginContainer, zoomContainer;
    let xAxis, yAxis;

    let width = 400, height = 400;
    let margin = { top: 10, right: 10, bottom: 40, left: 40 };
    let data;
    let xScale, yScale, zScale;
    let zoom;

    function resetZoom() {
      svg.call(zoom.transform, d3.zoomIdentity);
    }

    function initialize() {
      svg = d3.select("#svg");

      marginContainer = svg.append("g");
      zoomContainer = marginContainer.append("g");

      xAxis = svg.append("g")
        .attr("transform", `translate(${margin.left}, ${margin.top + height})`);

      yAxis = svg.append("g").attr("transform", `translate(${margin.left}, ${margin.top})`);

      xScale = d3.scaleLinear();
      yScale = d3.scaleLinear();
      zScale = d3.scaleOrdinal().domain(["Setosa", "Versicolor", "Virginica"]).range(d3.schemeCategory10)

      svg
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom);

      svg.append("defs")
        .append("clipPath")
        .attr("id", "clip")
        .append("rect")
        .attr("x", 0)
        .attr("y", 0)
        .attr("width", width)
        .attr("height", height);

      marginContainer
        .attr("transform", `translate(${margin.left}, ${margin.top})`)
        .attr("clip-path", "url(#clip)");

      d3.select("#x-variable").on("change", update);
      d3.select("#y-variable").on("change", update);

      zoom = d3.zoom()
        .extent([[0, 0], [width, height]])
        .scaleExtent([1, 8])
        .on("zoom", (zoomObj) => {
          let transform = zoomObj.transform;
          zoomContainer.attr("transform", transform);
          xAxis.call(d3.axisBottom(transform.rescaleX(xScale)));
          yAxis.call(d3.axisLeft(transform.rescaleY(yScale)));
        });


      svg.call(zoom);

      d3.select("#reset").on("click", resetZoom);
    }

    function update() {
      let xVar = d3.select("#x-variable").node().value;
      let yVar = d3.select("#y-variable").node().value;

      resetZoom();

      xScale = d3.scaleLinear().domain(d3.extent(data, d => d[xVar])).range([0, width]);
      yScale = d3.scaleLinear().domain(d3.extent(data, d => d[yVar])).range([height, 0]);

      zoomContainer.selectAll("circle")
        .data(data)
        .join("circle")
        .attr("cx", d => xScale(d[xVar]))
        .attr("cy", d => yScale(d[yVar]))
        .attr("fill", d => zScale(d.variety))
        .attr("r", 3)

      xAxis
        .call(d3.axisBottom(xScale));

      yAxis
        .call(d3.axisLeft(yScale));
    }

    d3.csv("C:/Users/user/Drive/강의/정보시각화/Lab/diabetes.csv")
      .then(csvData => {
        csvData.forEach(d => {
          d["Pregnancies"] = +d["Pregnancies"];
          d["Glucose"] = +d["Glucose"];
          d["BloodPressure"] = +d["BloodPressure"];
          d["SkinThickness"] = +d["SkinThickness"];
          d["Insulin"] = +d["Insulin"];
          d["BMI"] = +d["BMI"];
          d["DiabetesPedigreeFunction"] = +d["DiabetesPedigreeFunction"];
          d["Age"] = +d["Age"];
        });

        data = csvData;
        initialize();
        update();
      })

	$('#files').parse({
		config: {
			delimiter: "auto",
			complete: displayHTMLTable,
		},
		before: function(file, inputElem)
		{
			//console.log("Parsing file...", file);
		},
		error: function(err, file)
		{
			//console.log("ERROR:", err, file);
		},
		complete: function()
		{
			//console.log("Done with all files");
		}
	});
  </script>
</body>

</html>